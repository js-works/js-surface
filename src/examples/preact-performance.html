<!doctype html>
<html>
<head>
  <meta charset=utf-8>
  <meta http-equiv=X-UA-Compatible content=IE=edge>
  <title>Simple performance test</title>
  <script src="https://unpkg.com/preact"></script>
  <script src="https://unpkg.com/dio.js"></script>
  <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
</head>
<body>
  <div id="main-content"></div>
  <script>
    const lib = 'preact'

    let h, Component, render

    if (lib === 'react') {
      h = React.createElement
      Component = React.Component
      render = ReactDOM.render
    } else if (lib === 'dio') {
      h = dio.createElement
      Component = dio.Component
      render = dio.render
    } else if (lib === 'preact') {
      h = preact.h,
      Component = preact.Component
      render = preact.render
    }

    const
      framesPerSecond = 240,
      colors = ['red', 'yellow', 'orange'],
      tileWidth = 5,
      columnCount = 20,
      rowCount = 20

      const Tile = props => {
        const
          { width, color } = props,
          
          style = {
            float: 'left',
            width: width + 'px',
            height: width + 'px',
            backgroundColor: color,
            padding: 0,
            margin: 0
          }
          
        return h('div', { style })
      }

      const TileRow = props => {
        const
          { tileWidth, columnCount } = props,
          tiles = []

        for (let x = 0; x < columnCount; ++x) {
          const
            colorIdx = Math.floor(Math.random() * colors.length),       
            color = colors[colorIdx]
          
          tiles.push(Tile({ width: tileWidth, color, key: x }))
        }
      
        return h('div', { style: { clear: 'both' }}, tiles)
      }

      const SpeedTest = class extends Component {
        constructor(props) {
          super(props)

          this.__intervalId = null
          this.__startTime = Date.now()
          this.__frameCount = 0
          this.__actualFramesPerSecond = '0'
        }

        render() {
          const
            rows = [],
            
            style = {
            marginTop: 40,
            marginLeft: 40
          }

          for (let y = 0; y < this.props.rowCount; ++y) {
            rows.push(
              TileRow({
                tileWidth: this.props.tileWidth,
                columnCount: this.props.columnCount,
                key: y
              }))
          }
          
          return (
            h('div',
            null,
            h('div',
                null,
                `Rows: ${this.props.rowCount}, columns: ${this.props.columnCount}`,
                h('div',
                { style },
                rows)),
            h('p',
                { style: { clear: 'both' } },
            `(actual frames per second: ${this.__actualFramesPerSecond})`))
          )
        }

        componentDidMount() {
          this.intervalId = setInterval(() => {
            ++this.__frameCount
            this.forceUpdate(); 

            if (this.__frameCount % 10 === 0) {
            this.__actualFramesPerSecond =
                (this.__frameCount * 1000.0 /
                (Date.now() - this.__startTime)).toFixed(2)
            }
          }, 1000 / framesPerSecond)
        }

        componentWillUnmount() {
          clearInterval(this.intervalId)
          }
      }

    render(
      h(SpeedTest, { tileWidth, columnCount, rowCount }),
      document.getElementById('main-content'))
  </script>
</body>
